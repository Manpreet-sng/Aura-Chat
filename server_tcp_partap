import socket, threading, datetime, xml.etree.ElementTree as ET, os, csv, time

HOST = "0.0.0.0"
PORT = 12345
BROADCAST_PORT = 37020
TIMEOUT = 120
clients = {}
lock = threading.Lock()
LOG_FILE = "log_server.xml"

def log_message(sender, ip, content):
    if not os.path.exists(LOG_FILE) or os.path.getsize(LOG_FILE) == 0:
        root = ET.Element("logs")
        ET.ElementTree(root).write(LOG_FILE, encoding="utf-8", xml_declaration=True)
    tree = ET.parse(LOG_FILE)
    root = tree.getroot()
    msg = ET.SubElement(root, "message")
    ET.SubElement(msg, "timestamp").text = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    ET.SubElement(msg, "sender").text = sender
    ET.SubElement(msg, "ip").text = ip
    ET.SubElement(msg, "contenuto").text = content
    ET.indent(tree)
    tree.write(LOG_FILE, encoding="utf-8", xml_declaration=True)

def broadcaster():
    udp = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    udp.setsockopt(socket.SOL_SOCKET, socket.SO_BROADCAST, 1)
    while True:
        udp.sendto(b"AURASERVER", ('<broadcast>', BROADCAST_PORT))
        time.sleep(5)
threading.Thread(target=broadcaster, daemon=True).start()

def handle_client(sock, addr, uid):
    sock.settimeout(TIMEOUT)
    log_message("SERVER", addr[0], f"{uid} connected")
    while True:
        try:
            data = sock.recv(1024).decode()
            if not data: break
            log_message("CLIENT", addr[0], data) 
            print(data)
            parts = data.split()
            cmd = parts[0].upper()
            if cmd == "EXIT":
                sock.send("-1".encode()); break
            elif cmd == "TIME":   reply = datetime.datetime.now().strftime("%H:%M:%S")
            elif cmd == "NAME":   reply = socket.gethostname()
            elif cmd == "INFO" and len(parts)>1 and parts[1]=="1": reply = f"Connected clients: {len(clients)}"
            else: reply = "Command ok"
            sock.send(reply.encode())
            
            log_message("SERVER", addr[0], reply)
        except socket.timeout:
            break
        except:
            break
    with lock:
        if uid in clients: del clients[uid]
    sock.close()
    log_message("SERVER", addr[0], f"{uid} disconnected")

SERVER = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
SERVER.bind((HOST, PORT))
SERVER.listen(5)
print("AuraChat Server running...")
user_id = 1
while True:
    client_socket, client_address = SERVER.accept()
    uid = f"USER{user_id}"; user_id += 1
    with lock: clients[uid] = client_socket
    threading.Thread(target=handle_client, args=(client_socket, client_address, uid), daemon=True).start()
